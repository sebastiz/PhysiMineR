---
title: "Template Script"
author: "Sebastian Zeki"
date: "20/11/2018"
output: html_document

---


In patients being investigated for GORD with a negative pH impedance study who go on to have a BRAVO study, is there a significant increase between the two tests in the patients who have GORD, what can predict a BRAVO positive, pH impedance negative investigation to support a Straight-to-BRAVO test?
OR 

i). In patients being investigated for GORD with a negative impedance study for GORD who go on to have a BRAVO study, what proportion have a positive BRAVO for GORD condition
ii). What is the definition of a positive BRAVO.
iii). What predicts a positive BRAVO result in patients with negative impedance.
iv). 




```{r setup, warning = FALSE, message = FALSE,include=FALSE}
knitr::opts_chunk$set(results = 'asis', echo = FALSE, comment = FALSE,  warning = FALSE, message = FALSE, fig.align = 'center')
library(knitr)
library(here)
library(EndoMineR)
library(DiagrammeR)
library(CodeDepends)
library(readxl)
library(dplyr)
library(stringr)
library(here)
library(tidyr)
library(PhysiMineR)
library(DataExplorer)
```

### Introduction

**$\color{red}{\text{B.Introductory sentence 1: Define the disease condition}}$.**
**$\color{red}{\text{C.Introductory sentence 2: The overview of the disease condition}}$.**
**$\color{red}{\text{D.Introductory sentence 3: The problem being addressed}}$.**


### Aim

Determine whether there are any predictive factors from high resolution manometry or pH impedance in patients being investigated for reflux with a negative pH impedance result, that can predict a positive BRAVO result.



### Methods

The results of all patients who had undergone a succesful 24 hour pH impedance for any reason and a subsequent BRAVO between DATE(Get the dates from the minimum of the VisitDate column `r 1+1 `) were retrospectively investigated. Only patients had had undergone an initially negative 24 hour pH imepdance result were included (a pH negative impedance result was interpreted as:...... a positive BRAVO result was interpreted as.....).

To ensure that there was no duplicated data for patients who had undergone more than two of any test, only patients with pH impedance results before BRAVO were selected. The pH impedance closest to the BRAVO result was selected and only if there was less than one year's difference between the two. This was also the case for high resolution manometry studies.All patients selected were adults over the age of 18. Ethics was approved (IRAS number) and by the local ethics board. 

Patients were excluded for the following reasons: 

1. Previous oesophageal surgery or intervention such as endoscopic mucosal resection or radiofrequency ablation
2. Less than 24 hours of recording on pH impednace
3. 
4.
5.
6.

pH impedance: pH impedance was performed using ..... catheter. All patients had the pH impedance and manometry catheter as part of their routine clinical care. 

Symptoms at the time of the pH impedance were extracted from the self reporting records at the time of undergoing the study. For the analysis symptoms were grouped into oesophageal symptoms (heartburn, reflux....see the other) laryngopharyngeal reflux symptoms (cough, throat clearing, globus...see others) and abdominal symptoms (abdominal pain, bloating.....see others).

###### Pinched part
The study population consisted of adult patients (18 years of age) with refractory heartburn or suspected EER symptoms (asthma, cough, or hoarseness) referred to the Esophageal Motility Center at the Vanderbilt University Medical Center (Nashville, TN) and had failed > 8 week course of high dose (twice-daily) PPI therapy. Excluded were patients with a history of fundoplication, radiation, or malignancy. The external validation cohort obtained from the Mayo Clinic (Rochester, MN) and the Washington University in St Louis (St Louis, MO) used these same inclusion and exclusion criteria. All patients underwent esophagogastroduodenoscopy (EGD) and 48-hour wireless pH monitoring by a single provider . Data were prospectively collected and included patient characteristics (age, sex, race, and body mass index [BMI]), presence of secondary GERD symptoms (heartburn with or without regurgitation) in patients with primary extraesophageal symptoms, and current acidsuppressive medication regimen (or no treatment). The presence and size of a hiatal hernia and the presence and severity of esophagitis (graded by the Los Angeles Classification as A, B, C, or D) were determined with endoscopy. #########






```{r echo=FALSE}
read_chunk(here("inst","Projects","BRAVOStudies", "NegImpPredictorsOfAllPosBRAVO","munge", "PreProcessing.R"))
```



```{r dataImport,echo=FALSE}

```

Describe the data cleaning methodology


Statistical analyses:

Any variable with less than (x%) data completeness was removed from the study. Because records were collected over a large time frame, some elements of the datasets were not routinely collected. Where a variable was not available from the report, the raw file was located and manually analysed. Where this could not be done data was imputed using the multiple imputation in R (cite the MICE package). 


##### Pinched part
Quantitative data were presented as mean±SD. Data transformation by square root was applied to the operative time and blood loss during surgery, to meet the normality requirement. Operative time and blood loss were standardized by minusing their mean and then dividing by their SD.17 Student t test or χ2 test was applied to examine the difference of each variable as indicated. Linear regression was utilized to determine the relationships between the patients’ variables and endpoints (operative time, blood loss during surgery), whereas logistic regression was applied for postoperative morbidity. After univariate analysis, variables with a P<0.25 were selected for multivariate analysis. A multivariate analysis was performed using a multiple linear regression or logistic model, with a stepwise (forward selection/backward elimination) method. The statistical analysis was performed using SAS software (SAS Institute Inc., Cary, NC), and P<0.05 was considered to be significant.The strength of the corresponding associations was estimated by using univariate analysis and multivariate logistic regression analysis, and expressed as odds ratio (OR) #########

##### Pinched part
There was strict control and supervision of the data entry and access for this study and all data were collected and stored at the secure web-based Vanderbilt Digestive Disease Center REDCap (Research Electronic Data Capture; 1 UL1 RR024975 NCRR/NIH). Categorical variables were summarized using percentages and continuous variables were summarized using median and interquartile range (25th–75th percentile). Wilcoxon rank sum and Pearson c2 tests were used to compare continuous and categorical variables between groups, respectively. Separate multivariable proportional odds ordinal logistic regression models were developed for heartburn or EER symptoms to determine factors associated with abnormal pH. The 2 models were constructed by (1) pre-specifying a set of easily obtained demographic and clinical predictors, (2) fitting a multivariable model with these predictors, and (3) using a single backward selection step to remove insignificant predictors (P < .05) to simplify the model. For the heartburn model, the predictors age, BMI, hiatal hernia, and regurgitation were initially inputted. The EER model mirrored the heartburn model except for the addition of cough or hoarseness and asthma. Age and regurgitation were not significant in either model and were excluded. The model was based on continuous variables and then simplified to a scoring system that could be used at bedside. BMI was modeled flexibly as a continuous variable in the initial predictive model. We subsequently used a cutoff of BMI >25 kg/m2 in the final model because this corresponded to a similar percentage of increase in the probability of abnormal pH as the other binary predictors in the scoring system (heartburn and asthma). All analyses were conducted using the R statistical program using principles for reproducible research.16 We subsequently validated the performance of the prediction model using an external dataset from 2 tertiary care medical centers (Mayo Clinic and Washington University in St Louis) #########

```{r dataClean,echo=FALSE}
```

```{r dataIntraTestMerge,echo=FALSE}
```

```{r dataClean2,echo=FALSE}
```

```{r dataCrossTestMerge,echo=FALSE}
```

```{r dataForking,echo=FALSE}
```

```{r missingClean,echo=FALSE}
```

```{r VariableSelection,echo=FALSE}
```

Feature selection suggested the following variables for analysis:
LESlengthcm,BasalrespiratoryminmmHg,ResidualmeanmmHg,DistalcontractileintegralmeanmmHgcms,Contractilefrontvelocitycms,Distallatency,failedChicagoClassification,panesophagealpressurization,largebreaks,prematurecontraction,rapidcontraction,smallbreaks,AcidRefluxBRAVO,MainAcidExpTotalClearanceChannelNumberofAcidEpisodes,MainAcidExpTotalClearanceChannelPercentTime,MainAcidExpTotalClearanceChannelMeanAcidClearanceTime,MainAcidExpTotalClearanceChannelLongestEpisode,SAPOesophageal,SIOesophageal,SAPLPR,SILPR,SAPAbdo,SIAbdo.

The table below demonstrates the basic demographics for the patients

```{r Demographics,echo=FALSE}
library(table1)
table1(~ Age +factor(SAPOesophageal) + factor(SAPLPR) + factor(SAPAbdo) + factor(SIOesophageal) + factor(SILPR) + factor(SIAbdo) + LESlengthcm + BasalrespiratoryminmmHg + ResidualmeanmmHg + DistalcontractileintegralmeanmmHgcms + Contractilefrontvelocitycms + Distallatency + failedChicagoClassification + panesophagealpressurization + largebreaks + prematurecontraction + rapidcontraction + smallbreaks  + MainAcidExpTotalClearanceChannelNumberofAcidEpisodes + MainAcidExpTotalClearanceChannelPercentTime + MainAcidExpTotalClearanceChannelMeanAcidClearanceTime + MainAcidExpTotalClearanceChannelLongestEpisode | AcidRefluxBRAVO, data=NegImp_FromImpWithBRavoAndHRMMinSetQualityFinal,droplevels=T, render=rndr, render.strat=rndr.strat, overall=F)


# Table 1 - Patient demographics by variable of interest ----
#"Age" ,"SAPOesophageal", "SAPLPR" , "SAPAbdo"  had to be missing from below to allow it to run.
library(finalfit)
explanatory = c( "SIOesophageal" , "SILPR" , "SIAbdo" , "LESlengthcm" , "BasalrespiratoryminmmHg" , "ResidualmeanmmHg" , "DistalcontractileintegralmeanmmHgcms" , "Contractilefrontvelocitycms" , "Distallatency" , "failedChicagoClassification" , "panesophagealpressurization" , "largebreaks" , "prematurecontraction" , "rapidcontraction" , "smallbreaks"  , "MainAcidExpTotalClearanceChannelNumberofAcidEpisodes" , "MainAcidExpTotalClearanceChannelPercentTime" , "MainAcidExpTotalClearanceChannelMeanAcidClearanceTime" , "MainAcidExpTotalClearanceChannelLongestEpisode")
dependent = "AcidRefluxBRAVO" # Bowel perforation
NegImp_FromImpWithBRavoAndHRMMinSetQualityFinal$AcidRefluxBRAVO<-as.factor(NegImp_FromImpWithBRavoAndHRMMinSetQualityFinal$AcidRefluxBRAVO)
mydescTable<-NegImp_FromImpWithBRavoAndHRMMinSetQualityFinal %>%
  summary_factorlist(dependent, explanatory,
  p=TRUE, add_dependent_label=TRUE)

knitr::kable(mydescTable, row.names=FALSE, 
    align=c("l", "l", "r", "r", "r", "r"))


```

Demographic explanation here:

Table two illustrates the variables selected for analysis from the two groups



```{r HRM_UnivariateAnalysis,echo=FALSE}
```


Statistical modelling: A stepwise multiple logistic regression analysis was performed where the independent variables were those being analysed and the dependent variable was the presence of pathological acid reflux on a BRAVO study. ( performed using the package MASS in R (version and citation))

Table of multiple logistic regression results and odds ratios


```{r HRM_MultipleLogRegression,echo=FALSE}
#(1) Selection of independent variables; 
#(2) Fitting procedure; 
#(3) Coding of variables; 
#(4) Interactions; 
#(5) Collinearity; 
#(6) Statistical significance (OR, 95% confidence interval [CI], P value); 
#(7) Goodness-of-fit; 
#(8) Checking for outliers; 
#(9) Complete identification of the statistical software application that was used; 
#(10) Sufficient events (>10) per variable; 
#(11) Participation of statisticians and epidemiologists; and 
#(12) Conformity with linear gradient.
 library(Publish)
 #publish(step.model)
 #publish(step.model,factor.reference="inline")
 publish(step.model,pvalue.stars=TRUE)
 #publish(step.model,ci.format="(l,u)")
export_summs(step.model, scale = TRUE)

library(finalfit)
NegImp_FromImpWithBRavoAndHRMMinSetQualityFinal$AcidRefluxBRAVO<-as.factor(NegImp_FromImpWithBRavoAndHRMMinSetQualityFinal$AcidRefluxBRAVO)
#Note for some reason I cant get Age and SAP ones in here
explanatory = c("Age","SAPOesophageal","SAPLPR","SIOesophageal" , "SILPR" , "SIAbdo" , "LESlengthcm" , "BasalrespiratoryminmmHg" , "ResidualmeanmmHg" , "DistalcontractileintegralmeanmmHgcms" , "Contractilefrontvelocitycms" , "Distallatency" , "failedChicagoClassification" , "panesophagealpressurization" , "largebreaks" , "prematurecontraction" , "rapidcontraction" , "smallbreaks"  , "MainAcidExpTotalClearanceChannelNumberofAcidEpisodes" , "MainAcidExpTotalClearanceChannelPercentTime" , "MainAcidExpTotalClearanceChannelMeanAcidClearanceTime" , "MainAcidExpTotalClearanceChannelLongestEpisode")
dependent = 'AcidRefluxBRAVO'
mytable<-NegImp_FromImpWithBRavoAndHRMMinSetQualityFinal %>%
  finalfit(dependent, explanatory,metrics=TRUE)
knitr::kable(mytable, row.names=FALSE, 
    align=c("l", "l", "l", "l", "l", "l"))

myROC_plot
myROC_AUC
myCIplot

```

```{r diagrammeR,echo=FALSE}
```

## Results

**$\color{red}{\text{I.Describe demographics}}$.**
**$\color{red}{\text{J.Then describe level one results}}$.**
**$\color{red}{\text{K.Then describe subset results}}$.**


**Choose your statistical analysis**



## Discussion

**$\color{red}{\text{L.Sentence 1: To be decided}}$.**
**$\color{red}{\text{M.Sentence 2: To be decided}}$.**
**$\color{red}{\text{N.Sentence 3: To be decided}}$.**


## Limitations
**$\color{red}{\text{O.Sentence 1: To be decided}}$.**












